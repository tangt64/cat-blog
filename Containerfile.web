# --- 1단계: Maven으로 빌드 ---
FROM maven:3.9.9-eclipse-temurin-17 AS builder

# 작업 디렉토리
WORKDIR /app

# Maven 캐시 활용 위해 먼저 pom.xml 복사
COPY pom.xml .

# 의존성 다운로드
RUN mvn dependency:go-offline -B

# 소스 복사 후 빌드
COPY src ./src
RUN mvn clean package -DskipTests

# --- 2단계: Tomcat에 war 배포 ---
FROM tomcat:9.0-jdk17-temurin

# 기본 Tomcat webapps 제거 (불필요한 sample 앱들)
RUN rm -rf /usr/local/tomcat/webapps/*

# 빌드 결과물(.war) 복사 → ROOT.war 로 배치
COPY --from=builder /app/target/*.war /usr/local/tomcat/webapps/ROOT.war

# Tomcat 포트 오픈
EXPOSE 8080

# 실행
# CMD ["catalina.sh", "run"]
